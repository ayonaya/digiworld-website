  <script>
    // ... (rest of your checkout.html script) ...

            // --- NowPayments Button Click Handler ---
            nowpaymentsButton.addEventListener('click', async () => {
                if (!emailInput.value || !/^\S+@\S+\.\S+$/.test(emailInput.value)) {
                    resultMessageEl.textContent = 'Please enter a valid email address before paying with crypto.';
                    resultMessageEl.style.color = '#c0392b';
                    return;
                }
                
                resultMessageEl.textContent = 'Initiating crypto payment... Please wait.';
                resultMessageEl.style.color = '#3498db'; // Blue for crypto pending
                nowpaymentsButton.disabled = true; // Disable button to prevent multiple clicks
                paypalButtonContainer.style.display = 'none'; // Hide PayPal button when crypto is initiated
                paymentSeparator.style.display = 'none'; // Hide separator

                // --- ADDED DEBUGGING LOGS HERE ---
                const requestPayload = {
                    productId: productId,
                    email: emailInput.value,
                    amount: currentProductPrice.toFixed(2),
                    currency: 'USD', // Your base currency
                    payCurrency: 'usdt' // <--- THIS LINE MUST BE PRESENT AND CORRECT
                };
                console.log('NowPayments Request Payload:', requestPayload);
                // --- END DEBUGGING LOGS ---

                try {
                    const response = await fetch('/.netlify/functions/create-nowpayment-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestPayload)
                    });

                    const data = await response.json();

                    console.log('NowPayments API response data:', data); 
                    console.log('NowPayments API response ok status:', response.ok);

                    if (response.ok) {
                        resultMessageEl.textContent = 'Redirecting to NowPayments...';
                        if (data.payUrl) { // Check if payUrl exists
                            window.location.href = data.payUrl; // Redirect user to NowPayments page
                        } else {
                            console.error('NowPayments payUrl is missing from the response:', data);
                            resultMessageEl.style.color = '#c0392b';
                            resultMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> Failed to get redirection URL from NowPayments.`;
                            nowpaymentsButton.disabled = false; // Re-enable button on error
                            if (paypalButtonContainer.dataset.paypalAvailable === 'true') {
                                paypalButtonContainer.style.display = 'block'; 
                                paymentSeparator.style.display = 'block'; 
                            }
                        }
                    } else {
                        // This block will now correctly catch 4xx and 5xx errors from the function
                        resultMessageEl.style.color = '#c0392b';
                        resultMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> Failed to initiate crypto payment: ${data.message || 'Unknown error'}`;
                        nowpaymentsButton.disabled = false; // Re-enable button on error
                        if (paypalButtonContainer.dataset.paypalAvailable === 'true') {
                            paypalButtonContainer.style.display = 'block'; 
                            paymentSeparator.style.display = 'block'; 
                        }
                    }
                } catch (error) {
                    console.error('Error initiating NowPayments payment:', error);
                    resultMessageEl.style.color = '#c0392b';
                    resultMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> An error occurred while initiating crypto payment.`;
                    nowpaymentsButton.disabled = false; // Re-enable button on error
                    if (paypalButtonContainer.dataset.paypalAvailable === 'true') {
                        paypalButtonContainer.style.display = 'block'; 
                        paymentSeparator.style.display = 'block'; 
                    }
                }
            });

    // ... (rest of your checkout.html script) ...
  </script>
